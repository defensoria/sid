<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD iBatis Mapper 3.0 //EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="gob.dp.sid.registro.dao.ExpedienteDAO">
    
    <resultMap id="expedienteMap" type="expediente">
        <id property="id" column="N_IDEXPEDIENTE" />
        <result property="numero" column="C_NUMEROEXPEDIENTE"/>
        <result property="tipoClasificion" column="C_TIPOCLASIFICACION"/>
        <result property="tipoIngreso" column="C_TIPOINGRESO"/>
        <result property="tipoTema" column="C_TIPOTEMA"/>
        <result property="tipoSubtema" column="C_TIPOSUBTEMA"/>
        <result property="fechaIngreso" column="D_FECHAINGRESO"/>
        <result property="sumilla" column="C_SUMILLA"/>
        <result property="observacion" column="C_OBSERVACIONES"/>
        <result property="estadoCalificacion" column="C_ESTADOCALIFICACION"/>
        <result property="estadoInvestigacion" column="C_ESTADOINVESTIGACION"/>
        <result property="estadoPersuacion" column="C_ESTADOPERSUACION"/>
        <result property="estadoSeguimiento" column="C_ESTADOSEGUIMIENTO"/>
        <result property="estadoGestion" column="C_ESTADOGESTION"/>
        <result property="calificacion" column="N_CALIFICACION"/>
        <result property="usuarioRegistro" column="C_USUREGISTRO"/>
        <result property="estado" column="C_ESTADO"/>
        <result property="version" column="N_VERSION"/>
        <result property="fechaRegistro" column="D_FECHAREGISTRO"/>
        <result property="etiqueta" column="C_ETIQUETA"/>
        <result property="general" column="C_ESTADOGENERAL"/>
        <result property="clasificacionTipoNombre" column="TIPOCLASIFICACION"/>
        <result property="ingresoTipoNombre" column="TIPOINGRESO"/>
        <result property="ingresoTipoTema" column="TIPOTEMA"/>
        <result property="ingresoTipoSubTema" column="TIPOSUBTEMA"/>
        <result property="count" column="TOTAL"/>
        <result property="mes" column="MES"/>
        <result property="usuarioCompleto" column="USUARIOCOMPLETO"/>
        
        <result property="etapaDetalle" column="C_VALOR"/>
        <result property="indicadorEtapa" column="C_INDICADORETAPA"/>
        <result property="idEtapa" column="N_ID_ETAPA"/>
        <result property="estadoDetalle" column="C_NOMBRE"/>
    </resultMap> 
    
    
    <insert id="expedienteInsertar" parameterType="expediente">
        INSERT INTO SID_REG_EXPEDIENTE
        (
        <if test="tipoClasificion != null">
            C_TIPOCLASIFICACION,
        </if>
        <if test="tipoIngreso != null">
            C_TIPOINGRESO,
        </if>
        <if test="tipoTema != null">
            C_TIPOTEMA,
        </if>
        <if test="tipoSubtema != null">
            C_TIPOSUBTEMA,
        </if>
        <if test="fechaIngreso != null">
            D_FECHAINGRESO,
        </if>
        <if test="sumilla != null">
            C_SUMILLA,
        </if>
        <if test="observacion != null">
            C_OBSERVACIONES,
        </if>
        <if test="estadoCalificacion != null">
            C_ESTADOCALIFICACION,
        </if>
        <if test="estadoInvestigacion != null">
            C_ESTADOINVESTIGACION,
        </if>
        <if test="estadoPersuacion != null">
            C_ESTADOPERSUACION,
        </if>
        <if test="estadoSeguimiento != null">
            C_ESTADOSEGUIMIENTO,
        </if>
        <if test="estadoGestion != null">
            C_ESTADOGESTION,
        </if>
        <if test="calificacion != null">
            N_CALIFICACION,
        </if>
        <if test="usuarioRegistro != null">
            C_USUREGISTRO,
        </if>
        <if test="estado != null">
            C_ESTADO,
        </if>
        <if test="version != null">
            N_VERSION,
        </if>
        <if test="fechaRegistro != null">
            D_FECHAREGISTRO,
        </if>
        <if test="numero != null">
            C_NUMEROEXPEDIENTE,
        </if>
        <if test="etiqueta != null">
            C_ETIQUETA,
        </if>
        C_ESTADOGENERAL,
        N_IDEXPEDIENTE
        )
        VALUES 
        (
        <if test="tipoClasificion != null">
            #{tipoClasificion},
        </if>
        <if test="tipoIngreso != null">
            #{tipoIngreso},
        </if>
        <if test="tipoTema != null">
            #{tipoTema},
        </if>
        <if test="tipoSubtema != null">
            #{tipoSubtema},
        </if>
        <if test="fechaIngreso != null">
            #{fechaIngreso},
        </if>
        <if test="sumilla != null">
            #{sumilla},
        </if>
        <if test="observacion != null">
            #{observacion},
        </if>
        <if test="estadoCalificacion != null">
            #{estadoCalificacion},
        </if>
        <if test="estadoInvestigacion != null">
            #{estadoInvestigacion},
        </if>
        <if test="estadoPersuacion != null">
            #{estadoPersuacion},
        </if>
        <if test="estadoSeguimiento != null">
            #{estadoSeguimiento},
        </if>
        <if test="estadoGestion != null">
            #{estadoGestion},
        </if>
        <if test="calificacion != null">
            #{calificacion},
        </if>
        <if test="usuarioRegistro != null">
            #{usuarioRegistro},
        </if>
        <if test="estado != null">
            #{estado},
        </if>
        <if test="version != null">
            #{version},
        </if>
        <if test="fechaRegistro != null">
            #{fechaRegistro},
        </if>
        <if test="numero != null">
            #{numero},
        </if>
        <if test="etiqueta != null">
            #{etiqueta},
        </if>
        'A',
        SEQ_SID_REG_EXPEDIENTE.NextVal
        )
        <selectKey keyProperty="id" resultType="Long">
            SELECT SEQ_SID_REG_EXPEDIENTE.CURRVAL FROM DUAL
        </selectKey>
    </insert>
    
    
    <update id="expedienteUpdate" parameterType="expediente">
        UPDATE SID_REG_EXPEDIENTE
        <set>
            <if test="tipoClasificion != null">
                C_TIPOCLASIFICACION = #{tipoClasificion},
            </if>
            <if test="tipoIngreso != null">
                C_TIPOINGRESO = #{tipoIngreso},
            </if>
            <if test="tipoTema != null">
                C_TIPOTEMA = #{tipoTema},
            </if>
            <if test="tipoSubtema != null">
                C_TIPOSUBTEMA = #{tipoSubtema},
            </if>
            <if test="fechaIngreso != null">
                D_FECHAINGRESO = #{fechaIngreso},
            </if>
            <if test="sumilla != null">
                C_SUMILLA = #{sumilla},
            </if>
            <if test="observacion != null">
                C_OBSERVACIONES = #{observacion},
            </if>
            <if test="estadoCalificacion != null">
                C_ESTADOCALIFICACION  = #{estadoCalificacion},
            </if>
            <if test="estadoInvestigacion != null">
                C_ESTADOINVESTIGACION  = #{estadoInvestigacion},
            </if>
            <if test="estadoPersuacion != null">
                C_ESTADOPERSUACION  = #{estadoPersuacion},
            </if>
            <if test="estadoSeguimiento != null">
                C_ESTADOSEGUIMIENTO  = #{estadoSeguimiento},
            </if>
            <if test="estadoGestion != null">
                C_ESTADOGESTION  = #{estadoGestion},
            </if>
            <if test="calificacion != null">
                N_CALIFICACION = #{calificacion},
            </if>
            <if test="usuarioRegistro != null">
                C_USUREGISTRO = #{usuarioRegistro},
            </if>
            <if test="estado != null">
                C_ESTADO = #{estado},
            </if>
            <if test="fechaRegistro != null">
                D_FECHAREGISTRO = #{fechaRegistro},
            </if>
            <if test="etiqueta != null">
                C_ETIQUETA = #{etiqueta},
            </if>
            <if test="numero != null">
                C_NUMEROEXPEDIENTE = #{numero}
            </if>
        </set>
        <where>
            N_IDEXPEDIENTE = #{id}
        </where>
    </update>
    
    <update id="expedienteConcluir" parameterType="long">
        UPDATE SID_REG_EXPEDIENTE
        <set>
            C_ESTADOGENERAL = 'C'
        </set>
        <where>
            N_IDEXPEDIENTE = #{id}
        </where>
    </update>
    
    
    <select id="expedienteBuscar" resultMap="expedienteMap" parameterType="expediente">
        SELECT A.*, 
        B.NOMBRE_PARAMETRO TIPOCLASIFICACION,
        C.NOMBRE_PARAMETRO TIPOINGRESO,
        D.NOMBRE_PARAMETRO TIPOTEMA,
        E.NOMBRE_PARAMETRO TIPOSUBTEMA
        FROM SID_REG_EXPEDIENTE A
        LEFT JOIN SID_PARAMETRO B 
        ON A.C_TIPOCLASIFICACION = B.VALOR_PARAMETRO AND B.PADRE_PARAMETRO = 10
        LEFT JOIN SID_PARAMETRO C   
        ON A.C_TIPOINGRESO = C.VALOR_PARAMETRO AND C.PADRE_PARAMETRO = 20
        LEFT JOIN SID_PARAMETRO D   
        ON A.C_TIPOTEMA = D.VALOR_PARAMETRO AND D.PADRE_PARAMETRO = 30   
        LEFT JOIN SID_PARAMETRO E  
        ON E.PADRE_PARAMETRO = D.NUM_PARAMETRO AND A.C_TIPOSUBTEMA = E.VALOR_PARAMETRO
        WHERE A.C_ESTADO = 'A'
    </select>
    
    <select id="expedienteBuscarActivo" resultMap="expedienteMap" parameterType="expediente">
        SELECT A.*, 
        B.NOMBRE_PARAMETRO TIPOCLASIFICACION,
        C.NOMBRE_PARAMETRO TIPOINGRESO,
        D.NOMBRE_PARAMETRO TIPOTEMA,
        E.NOMBRE_PARAMETRO TIPOSUBTEMA
        FROM SID_REG_EXPEDIENTE A
        INNER JOIN SID_REG_ETAPA_ESTADO F ON A.N_IDEXPEDIENTE = F.N_ID_EXPEDIENTE
        LEFT JOIN SID_PARAMETRO B 
        ON A.C_TIPOCLASIFICACION = B.VALOR_PARAMETRO AND B.PADRE_PARAMETRO = 10
        LEFT JOIN SID_PARAMETRO C   
        ON A.C_TIPOINGRESO = C.VALOR_PARAMETRO AND C.PADRE_PARAMETRO = 20
        LEFT JOIN SID_PARAMETRO D   
        ON A.C_TIPOTEMA = D.VALOR_PARAMETRO AND D.PADRE_PARAMETRO = 30   
        LEFT JOIN SID_PARAMETRO E  
        ON E.PADRE_PARAMETRO = D.NUM_PARAMETRO AND A.C_TIPOSUBTEMA = E.VALOR_PARAMETRO
        WHERE A.C_ESTADO = 'A'
        AND F.C_NUMEROEXPEDIENTE = #{numero}
        AND F.C_INDICADOR = 'ACT'
    </select>
    
    <select id="expedienteBuscarActivoEtapa" resultMap="expedienteMap" parameterType="expediente">
        SELECT A.*, 
        B.NOMBRE_PARAMETRO TIPOCLASIFICACION,
        C.NOMBRE_PARAMETRO TIPOINGRESO,
        D.NOMBRE_PARAMETRO TIPOTEMA,
        E.NOMBRE_PARAMETRO TIPOSUBTEMA
        FROM SID_REG_EXPEDIENTE A
        INNER JOIN SID_REG_ETAPA_ESTADO F ON A.N_IDEXPEDIENTE = F.N_ID_EXPEDIENTE
        LEFT JOIN SID_PARAMETRO B 
        ON A.C_TIPOCLASIFICACION = B.VALOR_PARAMETRO AND B.PADRE_PARAMETRO = 10
        LEFT JOIN SID_PARAMETRO C   
        ON A.C_TIPOINGRESO = C.VALOR_PARAMETRO AND C.PADRE_PARAMETRO = 20
        LEFT JOIN SID_PARAMETRO D   
        ON A.C_TIPOTEMA = D.VALOR_PARAMETRO AND D.PADRE_PARAMETRO = 30   
        LEFT JOIN SID_PARAMETRO E  
        ON E.PADRE_PARAMETRO = D.NUM_PARAMETRO AND A.C_TIPOSUBTEMA = E.VALOR_PARAMETRO
        WHERE F.C_NUMEROEXPEDIENTE = #{numero}
        AND F.C_INDICADORETAPA = 'VIG'
        AND F.N_ID_ETAPA = #{idEtapa}
    </select>
    
    <select id="expedienteBuscarUsuario" resultMap="expedienteMap" parameterType="String">
        SELECT A.*, B.NOMBRE_PARAMETRO AS TIPOCLASIFICACION FROM SID_REG_EXPEDIENTE A
        INNER JOIN SID_PARAMETRO B ON A.C_TIPOCLASIFICACION = B.VALOR_PARAMETRO
        AND B.PADRE_PARAMETRO = 10
        WHERE A.C_USUREGISTRO  = #{value}
        AND A.C_ESTADO = 'A'
    </select>
    
    <select id="expedienteReporteMesUsuario" resultMap="expedienteMap" parameterType="expediente">
        SELECT COUNT(A.N_IDEXPEDIENTE) TOTAL, TO_CHAR(A.D_FECHAINGRESO, 'YYYY-MM') MES FROM SID_REG_EXPEDIENTE A
        WHERE A.C_USUREGISTRO  = #{usuarioRegistro}
        AND A.C_ESTADO = 'A'
        AND A.C_TIPOCLASIFICACION = #{tipoClasificion}
        GROUP BY TO_CHAR(A.D_FECHAINGRESO, 'YYYY-MM')
    </select>
    
    <select id="expedientexPersona" resultMap="expedienteMap" parameterType="expediente">
        SELECT A.*, B.NOMBRE_PARAMETRO AS TIPOCLASIFICACION FROM SID_REG_EXPEDIENTE A 
        INNER JOIN SID_PARAMETRO B ON A.C_TIPOCLASIFICACION = B.VALOR_PARAMETRO
        AND B.PADRE_PARAMETRO = 10
INNER JOIN SID_REG_EXPEDE_PERSONA C ON A.N_IDEXPEDIENTE = C.N_IDEXPEDIENTE
WHERE C.N_IDPERSONA = #{id} AND A.C_ESTADO = 'A'
        ORDER BY A.N_IDEXPEDIENTE DESC
    </select>
    
    
    <select id="expedienteBuscarUsuarioPaginado" resultMap="expedienteMap" parameterType="expediente">
        SELECT A.*
        FROM (
        SELECT
        B.*,
        ROWNUM numfila
        FROM (
        SELECT A.*, B.NOMBRE_PARAMETRO AS TIPOCLASIFICACION, C.C_INDICADORETAPA, C.N_ID_ETAPA, D.C_NOMBRE FROM SID_REG_EXPEDIENTE A
        INNER JOIN SID_PARAMETRO B ON A.C_TIPOCLASIFICACION = B.VALOR_PARAMETRO AND B.PADRE_PARAMETRO = 10
        LEFT JOIN SID_REG_ETAPA_ESTADO C ON A.N_IDEXPEDIENTE = C.N_ID_EXPEDIENTE
        LEFT JOIN SID_REG_ESTADO D ON C.N_ID_ESTADO = D.N_ID_ESTADO
        WHERE A.C_USUREGISTRO  = #{usuarioRegistro}
        AND A.C_ESTADO = 'A'
        ORDER BY A.N_IDEXPEDIENTE DESC
        ) B
        ) A WHERE a.numfila BETWEEN #{ini} AND #{fin}
    </select>
    
    <select id="expedienteBuscarUsuarios" resultMap="expedienteMap" parameterType="expediente">
        SELECT DISTINCT A.C_USUREGISTRO, B.NOM_USUARIO||' '||B.APE_PATERNO||' '||B.APE_MATERNO  USUARIOCOMPLETO FROM SID_REG_EXPEDIENTE A 
        INNER JOIN SID_SEG_USUARIO B ON A.C_USUREGISTRO = B.CODIGO_USUARIO
        WHERE A.C_ESTADO = 'A' AND A.N_VERSION > 0
    </select>
    
</mapper>